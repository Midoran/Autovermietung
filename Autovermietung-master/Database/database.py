# flake8: noqa:E501

import cx_Oracle
import json

def connect_to_database():
    with open('Database/config.json') as config_file:
        config_data = json.load(config_file)

    user = config_data.get('DATABASE_USER')
    password = config_data.get('DATABASE_PASSWORD')
    host = config_data.get('DATABASE_HOST')
    port = config_data.get('DATABASE_PORT')
    service_name = config_data.get('DATABASE_SERVICE')

    dsn_tns = cx_Oracle.makedsn(host, port, service_name=service_name)
    return cx_Oracle.connect(user=user, password=password, dsn=dsn_tns)

def get_create_table_statements():

    return [
        """CREATE TABLE Standorte (
        StandortID NUMBER GENERATED BY DEFAULT AS IDENTITY,
        Standortname VARCHAR2(255) NOT NULL,
        AdressePLZ VARCHAR2(255) NOT NULL,
        AdresseStrasse VARCHAR2(255) NOT NULL,
        AdresseWohnort VARCHAR2(255) NOT NULL,
        AnzahlStellplatz NUMBER NOT NULL,
        PRIMARY KEY (StandortID)
        )""",

        """CREATE TABLE Fahrzeuge (
        FahrzeugID NUMBER GENERATED BY DEFAULT AS IDENTITY,
        StandortID NUMBER NOT NULL,
        Hersteller VARCHAR2(255) NOT NULL,
        Modell VARCHAR2(255) NOT NULL,
        Baujahr NUMBER,
        Verf端gbarkeit CHAR(1) NOT NULL,
        Preis FLOAT NOT NULL,
        Kilometerstand FLOAT NOT NULL,
        Kennzeichen VARCHAR2(255) NOT NULL,
        Fahrzeugklasse VARCHAR2(255) NOT NULL,
        Wartungsstatus VARCHAR2(255),
        PRIMARY KEY (FahrzeugID)
        )""",

        """CREATE TABLE Kunden (
        KundenID NUMBER GENERATED BY DEFAULT AS IDENTITY,
        Vorname VARCHAR2(255) NOT NULL,
        Nachname VARCHAR2(255) NOT NULL,
        Geburtsdatum DATE NOT NULL,
        AdressePLZ NUMBER NOT NULL,
        AdresseStrasse VARCHAR2(255) NOT NULL,
        AdresseWohnort VARCHAR2(255) NOT NULL,
        F端hrerscheinnummer NUMBER NOT NULL,
        F端hrerscheinklasse VARCHAR2(255) NOT NULL,
        Telefonnummer VARCHAR2(255) NOT NULL,
        Email VARCHAR2(255) NOT NULL,
        Passwort VARCHAR2(255) NOT NULL,
        PRIMARY KEY (KundenID)
        )""",

        """CREATE TABLE Mitarbeiter (
        MitarbeiterID NUMBER GENERATED BY DEFAULT AS IDENTITY,
        Vorname VARCHAR2(255) NOT NULL,
        Nachname VARCHAR2(255) NOT NULL,
        Position VARCHAR2(255) NOT NULL,
        Email VARCHAR2(255) NOT NULL,
        PRIMARY KEY (MitarbeiterID)
        )""",

        """CREATE TABLE Reservierungen (
        ReservierungsID NUMBER GENERATED BY DEFAULT AS IDENTITY,
        Kilometerstand FLOAT NOT NULL,
        StartDatum DATE NOT NULL,
        EndDatum DATE NOT NULL,
        Status CHAR(1) NOT NULL,
        FahrzeugID NUMBER NOT NULL,
        KundenID NUMBER NOT NULL,
        MitarbeiterID NUMBER NOT NULL,
        PRIMARY KEY (ReservierungID)
        )""",

        """CREATE TABLE Rechnungen (
        RechnungID NUMBER GENERATED BY DEFAULT AS IDENTITY,
        Rechnungsdatum DATE NOT NULL,
        Rechnungsbetrag FLOAT NOT NULL,
        Status CHAR(1) NOT NULL,
        ReservierungID NUMBER NOT NULL,
        KundenID NUMBER NOT NULL,
        PRIMARY KEY (RechnungID)
        )""",

        """CREATE TABLE Wartungen (
        WartungsID NUMBER GENERATED BY DEFAULT AS IDENTITY,
        FahrzeugID NUMBER NOT NULL,
        Wartungsdatum DATE NOT NULL,
        Beschreibung VARCHAR2(1000),
        Bemerkungen VARCHAR2(1000),
        PRIMARY KEY (WartungsID)
        )"""
    ]


def get_alter_table_statements():

    return [
        """ALTER TABLE Fahrzeuge
        ADD FOREIGN KEY (StandortID) REFERENCES Standorte(StandortID)""",

        """ALTER TABLE Rechnungen
        ADD FOREIGN KEY (ReservierungsID) REFERENCES
        Reservierungen(ReservierungID)""",

        """ALTER TABLE Rechnungen
        ADD FOREIGN KEY (KundenID) REFERENCES Kunden(KundenID)""",

        """ALTER TABLE Kunden
        ADD FOREIGN KEY (ReservierungsID) REFERENCES Reservierungen(ReservierungsID)""",

        """ALTER TABLE Reservierungen
        ADD FOREIGN KEY (KundenID) REFERENCES Kunden(KundenID)""",

        """ALTER TABLE Reservierungen
        ADD FOREIGN KEY (FahrzeugID) REFERENCES Fahrzeuge(FahrzeugID)""",

        """ALTER TABLE Reservierungen
        ADD FOREIGN KEY (MitarbeiterID) REFERENCES Mitarbeiter(MitarbeiterID)""",

        """ALTER TABLE Wartungen
        ADD FOREIGN KEY (FahrzeugID) REFERENCES Fahrzeuge(FahrzeugID)"""

    ]


def execute_sql_in_transaction(connection, statements):
    try:
        with connection.cursor() as cursor:
            for sql in statements:
                cursor.execute(sql)
        connection.commit()
    except cx_Oracle.DatabaseError as e:
        connection.rollback()
        print(f"Fehler bei der Ausf端hrung von SQL: {sql}")
        print(f"Oracle-Error: {e}")


def setup_database():
    conn = connect_to_database()

    try:

        conn.begin()

        create_table_statements = get_create_table_statements()
        for statement in create_table_statements:
            execute_sql_in_transaction(conn, [statement])

        alter_table_statements = get_alter_table_statements()
        for statement in alter_table_statements:
            execute_sql_in_transaction(conn, [statement])

        conn.commit()

    except cx_Oracle.DatabaseError as e:
        conn.rollback()
        print(f"Verbindungsfehler: {e}")

    finally:
        conn.close()